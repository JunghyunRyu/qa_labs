# AI 작업 안전 수칙 (AI Safety Protocols)

**중요:** 이 문서는 프로젝트의 헌법과 같습니다.  
모든 제안과 코드 수정 전에 이 규칙을 우선적으로 적용해야 합니다.

---

## 0. 문서 자체에 대한 규칙

- **AI는 이 문서(`AI_SAFETY_PROTOCOLS.md`)를 직접 수정하거나 리팩토링하지 않습니다.**
- 변경이 필요하다고 판단되면,  
  - 변경 이유와 수정 초안을 "제안"만 하고,  
  - 실제 편집/커밋은 사람이 수행해야 합니다.

---

## 1. ⛔ 절대 금지 사항 (Critical Restrictions)

다음 작업은 시스템 장애 및 데이터 손실을 유발하므로,  
**사용자의 명시적 승인 없이는 절대 제안하거나 실행하지 않습니다.**

### 1.1 Docker 및 데이터 관련

- **`down -v` 금지**
  - 프로덕션에서 `docker compose down -v`, `docker volume rm`, `docker volume prune` 을 사용하지 않습니다.
  - 이유: DB 데이터 및 기타 영구 볼륨이 영구 삭제됩니다.
- **DB 데이터 디렉터리 삭제 금지**
  - `/var/lib/postgresql/data` 등 Postgres 데이터와 매핑된 호스트 디렉터리를 삭제하거나 덮어쓰지 않습니다.
- **볼륨 경로 임의 변경 금지**
  - DinD 환경에서 사용하는 공유 경로:
    - 호스트 및 컨테이너 공유 디렉터리: `/tmp/qa_arena_judge`
  - 이 경로는 `celery_worker` 와 `judge` 컨테이너 간의 약속된 경로입니다.
  - `docker-compose.yml` 이나 애플리케이션 코드에서 이 경로를 임의로 변경하지 않습니다.

### 1.2 인프라 / 설정 파일 관련

다음 파일들은 **제안만 가능**하며, AI가 자동으로 덮어쓰거나 크게 재구성하지 않습니다.

- `docker-compose.prod.yml`
- `nginx/qa_arena.conf`
- 프로덕션 `.env` (환경 변수 파일)
- SSL/도메인 관련 설정 (`/etc/letsencrypt/**` 및 관련 마운트)

이 파일들을 수정할 필요가 있는 경우:

1. 변경 필요성을 설명하는 제안을 먼저 작성하고,
2. 사용자가 수동으로 수정/검토하는 것을 기본 전제로 합니다.

### 1.3 네트워크 / 보안 관련

- AWS 보안 그룹, IAM, SSM, ufw, iptables 설정을 직접 변경하는 명령은 제안하지 않습니다.
- SSH 접속 장애가 발생한 경우:
  - 우선 순위 진입 경로는 **AWS Systems Manager(Session Manager)** 입니다.
  - AI는 "SSM으로 인스턴스에 접속하여 로그를 확인하라"는 수준의 안내만 합니다.
  - 보안 그룹/ufw 설정 변경은 반드시 사람이 AWS 콘솔/서버에서 수동으로 처리해야 합니다.

### 1.4 비밀정보(Secrets) 관련

- `.env` 파일, API 키, 토큰(PAT 등), 인증서 비밀키 등의 **실제 값**을 문서/코드/로그에 그대로 남기지 않습니다.
- 예시, 스니펫 제공 시에는 항상 더미 값(예: `YOUR_API_KEY_HERE`)을 사용합니다.
- 이미 노출된 키는 **재발급/폐기**가 필요하다는 점을 명확히 안내합니다.

---

## 2. 🛡️ DB 백업/복구 및 마이그레이션 규칙

### 2.1 백업 스크립트

- 프로덕션 DB 백업은 다음 스크립트를 사용합니다.

```bash
./scripts/backup_db.sh
```

- 이 스크립트는 다음을 가정합니다.
  - Postgres 컨테이너: `qa_arena_postgres_prod`
  - DB 이름/유저: `.env` 및 Docker 설정과 동일
  - 백업 생성 위치(호스트): `/backup/postgres/qa_arena_YYYYMMDD_HHMMSS.dump`

### 2.2 마이그레이션 전 필수 절차

DB 스키마 변경(모델 변경, Alembic 마이그레이션 포함)을 제안할 때는 **항상** 다음 순서를 따릅니다.

1. **백업 선행 제안**
   - "마이그레이션 실행 전에 `./scripts/backup_db.sh` 를 먼저 실행해 주세요." 라고 안내합니다.
2. **백업 생성 확인**
   - `/backup/postgres` 디렉터리에 새로운 `qa_arena_*.dump` 파일이 생성되었는지 확인하도록 안내합니다.
3. **마이그레이션 적용**
   - Alembic 마이그레이션 파일 생성은 가능하지만,
   - 실제 `alembic upgrade head` 실행은 사용자가 수행하는 것을 기본으로 합니다.

### 2.3 복구/검증

- 덤프 유효성 검증은 Postgres 컨테이너에서 다음과 같이 수행할 수 있다고 안내합니다.

```bash
docker exec -it qa_arena_postgres_prod   pg_restore -l /var/lib/postgresql/data/backups/<덤프파일명> | head
```

- 전체 복구 및 장애 복구 절차는 별도의 `backup_restore.md` / `operations.md` 를 참조합니다.

---

## 3. 🧪 작업 전 필수 체크리스트 (Pre-flight Checks)

### 3.1 코드 수정 및 배포 시

1. **DB 변경 포함 여부**
   - 모델/스키마 변경, 마이그레이션 추가 여부를 먼저 확인합니다.
   - [Yes] 인 경우 → 2번에서 **백업 실행**을 선행하도록 제안합니다.
2. **환경 구분**
   - 현재 작업이 로컬(Windows)인지, EC2(Linux)인지 명확히 합니다.
   - 로컬 작업 시:
     - `C:\...` 경로, Windows 명령(PowerShell, Git Bash)을 사용합니다.
     - 리눅스 전용 경로(`/var/...`, `/home/ubuntu/...`)는 사용하지 않습니다.
   - EC2 작업 시:
     - 절대 경로(`/home/ubuntu/qa_labs` 등)를 기준으로 명령을 구성합니다.
3. **인코딩 주의**
   - 한글 주석/문자열 포함 시, 파일 인코딩이 UTF-8임을 전제로 합니다.
   - Windows에서 편집 후 Linux로 배포되는 파일의 인코딩/줄바꿈 문제에 유의합니다.

### 3.2 에러 대응 시 (Troubleshooting)

1. **로그 우선 원칙**
   - 컨테이너 재시작/재배포를 제안하기 전에,  
     `docker compose -f docker-compose.prod.yml logs <서비스명>` 으로 로그를 먼저 확인하도록 안내합니다.
2. **DinD 볼륨 문제**
   - `file not found`, 경로 관련 오류 발생 시:
     - 경로를 새로 바꾸기보다,  
       - 호스트의 `/tmp/qa_arena_judge` 디렉터리 존재 여부,
       - 권한(예: 777) 여부를 먼저 확인하도록 제안합니다.
3. **무한 재시작**
   - 특정 컨테이너가 반복 재시작될 경우:
     - 무작정 `/deploy` 를 실행하지 않고,
     - Nginx/Backend/Worker 각각의 로그를 보고 원인을 파악한 후 최소 변경만 제안합니다.

---

## 4. 🤖 AI의 권한 범위 (Scope of Authority)

| 영역                           | AI 권한         | 설명 |
|--------------------------------|-----------------|------|
| 비즈니스/도메인 로직 (Python, API) | ✅ 수정 가능      | 기능 개선, 리팩토링, 버그 수정 |
| 테스트 코드                    | ✅ 수정 가능      | 테스트 케이스 추가/수정, 커버리지 향상 |
| 문서 (`*.md`)                  | ✅ 수정 가능      | 스펙/가이드/에러 핸들링 문서 정리 |
| 로컬 개발용 스크립트           | ✅ 수정 가능      | Windows/로컬 환경 관련 자동화 스크립트 |
| Docker 설정 (`docker-compose.*`) | ⚠️ 제안만 가능     | 수정 초안 제안까지, 실제 적용/커밋은 사람이 수행 |
| DB 스키마/Alembic              | ⚠️ 제안만 가능     | 마이그레이션 파일 생성 제안까지, 실행은 사람이 수행 |
| 프로덕션 `.env` / 비밀정보     | ⛔ 접근/출력 금지  | 실제 값 노출 금지, 더미 값만 예시로 사용 |
| SSL/도메인/보안그룹/SSM/IAM    | ⛔ 직접 변경 금지  | 구조/개념 설명, 사람이 할 작업을 안내하는 수준까지만 수행 |

---

## 5. Slash Commands 사용 가이드

- **`/deploy`**
  - 단순 코드 변경(로직/뷰 수정 등) 시에만 사용합니다.
  - DB 스키마 변경이 포함된 경우, `/deploy` 자동 실행을 제안하지 않습니다.
  - 반드시:
    1. 변경 범위를 요약하고,
    2. DB 영향 여부를 확인한 뒤,
    3. 필요 시 백업 실행을 먼저 안내합니다.

- **`/logs`**
  - 장애 분석을 위해 안전하게 사용할 수 있습니다.
  - 로그 결과를 바탕으로 파괴적인 명령(볼륨 삭제, 인프라 재구성 등)을 자동으로 이어서 제안하지 않습니다.

- **`/test-submit`**
  - 제출 테스트 시, 로컬/EC2 환경에 맞는 URL(`http://localhost:8001`, 실제 도메인 등)을 명확히 구분하도록 합니다.

- **`/check-sync`**
  - 로컬과 EC2 코드 싱크 상태 확인용으로 사용하며,
  - 싱크 불일치 시 `git pull`, `git stash` 등 안전한 Git 작업 흐름만 제안합니다.
